name: Check homework
on: [push]

jobs:
  runner-job:
    if: ${{ github.repository_owner != 'ktsstudio' }}
    runs-on: ubuntu-latest

    env:
      IMAGE: 'ktshub/backend-summer-2021:task-6ff8c4a9-3f65-442b-b91c-1f5aaa9c3581'
      CONFIGPATH: /go/code/source/tests/config.yml
      PYTHONPATH: /go/code/source

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd "pg_isready"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v3

      - name: Set project path
        run: echo "PROJECTPATH=$(pwd)" >> $GITHUB_ENV

      - name: Wait for Postgres
        run: |
          for i in {1..10}; do
            pg_isready -h localhost -p 5432 -U postgres && break
            echo "Waiting for Postgres..."
            sleep 3
          done

      - name: Import demo SQL
        run: |
          export PGPASSWORD="$POSTGRES_PASSWORD"
          psql --host=localhost --port=5432 --username=postgres --dbname=postgres \
               -f "$PROJECTPATH/tests/data/demo.sql"

      - name: Run main and tests in Docker
        run: |
          docker run \
            --rm \
            --entrypoint /bin/bash \
            -e GITHUB_REPOSITORY \
            -e GITHUB_REF \
            -e CONFIGPATH=${{ env.CONFIGPATH }} \
            -e PYTHONPATH=${{ env.PYTHONPATH }} \
            --network host \
            --mount src="$(pwd)",target=/go/code/source,type=bind \
            ${{ env.IMAGE }} \
            -c "cd /go/code/source && ls -lah tests && ./main"
