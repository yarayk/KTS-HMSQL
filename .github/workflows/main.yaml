name: Check homework
on: [push]

jobs:
  runner-job:
    if: ${{ github.repository_owner != 'ktsstudio' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      IMAGE: 'ktshub/backend-summer-2021:task-6ff8c4a9-3f65-442b-b91c-1f5aaa9c3581'
      # Absolute path inside container where we mount the repo
      CONTAINER_REPO_PATH: /go/code/source
      # Path for config when running tests on runner
      CONFIGPATH_RUNNER: ${{ github.workspace }}/tests/config.yml
      PYTHONPATH: ${{ github.workspace }}
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DATABASE: postgres
      POSTGRES_PORT: 5432

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Show workspace (debug)
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          pwd
          ls -la

      - name: Ensure demo.sql and config.yml exist (debug)
        run: |
          echo "Listing tests and tests/data"
          ls -la tests || true
          ls -la tests/data || true
          if [ -f tests/config.yml ]; then echo "Found tests/config.yml"; else echo "WARNING: tests/config.yml not found"; fi
          if [ -f tests/data/demo.sql ]; then echo "Found tests/data/demo.sql"; else echo "ERROR: demo.sql missing"; fi

      - name: Install PostgreSQL client (psql / pg_isready)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client

      - name: Wait for Postgres to be ready
        run: |
          echo "Waiting for Postgres on localhost:${{ env.POSTGRES_PORT }}..."
          for i in {1..30}; do
            PGPASSWORD=${{ env.POSTGRES_PASSWORD }} pg_isready -h localhost -p ${{ env.POSTGRES_PORT }} -U ${{ env.POSTGRES_USER }} && break
            echo "Postgres not ready yet ($i)..."
            sleep 2
          done
          # show final status
          PGPASSWORD=${{ env.POSTGRES_PASSWORD }} pg_isready -h localhost -p ${{ env.POSTGRES_PORT }} -U ${{ env.POSTGRES_USER }}

      - name: Import demo.sql into Postgres
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: ${{ env.POSTGRES_PORT }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_DATABASE: ${{ env.POSTGRES_DATABASE }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          echo "Importing tests/data/demo.sql into Postgres..."
          PGPASSWORD="$POSTGRES_PASSWORD" \
            psql --host="$POSTGRES_HOST" \
                 --port="$POSTGRES_PORT" \
                 --username="$POSTGRES_USER" \
                 --dbname="$POSTGRES_DATABASE" \
                 -f tests/data/demo.sql

      - name: Run container image (run ./main if present)
        env:
          CONFIGPATH: ${{ env.CONTAINER_REPO_PATH }}/tests/config.yml
          PYTHONPATH: ${{ env.CONTAINER_REPO_PATH }}
        run: |
          echo "Starting container image and attempting to run ./main if present..."
          docker run --rm \
            --entrypoint /bin/bash \
            -e GITHUB_REPOSITORY \
            -e GITHUB_REF \
            -e CONFIGPATH=${{ env.CONFIGPATH }} \
            -e PYTHONPATH=${{ env.PYTHONPATH }} \
            --network host \
            --mount src="$(pwd)",target=${{ env.CONTAINER_REPO_PATH }},type=bind \
            ${{ env.IMAGE }} \
            -c "set -e
                cd ${{ env.CONTAINER_REPO_PATH }}
                echo 'Contents of repo inside container:'
                ls -lah || true
                echo 'Contents of tests inside container:'
                ls -lah tests || true
                # If build/main exists, try to run it (keep behavior similar to original),
                # otherwise skip gracefully.
                if [ -f build/main ]; then
                  echo 'Found build/main - moving and running...'
                  mv build/main source || true
                  cd source || true
                  ./main
                else
                  echo 'No build/main found; skipping ./main run in container.'
                fi"

      - name: Install Python deps & run pytest on runner
        env:
          CONFIGPATH: ${{ env.CONFIGPATH_RUNNER }}
          PYTHONPATH: ${{ env.PYTHONPATH }}
        run: |
          echo "CONFIGPATH (runner) = $CONFIGPATH"
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found, skipping pip install -r requirements.txt"
          fi
          echo "Listing tests directory:"
          ls -la tests || true
          echo "Show config file:"
          ls -la "$(dirname "$CONFIGPATH")" || true
          echo "Running pytest..."
          pytest -q tests/
